–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ
SELECT count() FROM fpds_clickhouse.raw_contracts;

–°—Ä–∞–≤–Ω–∏—Ç—å –≤ MySQL
SELECT SUM(inserted_records) AS total_inserted_records FROM file_processing_status; 

–†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –≤ –ú–ë
SELECT 
    name, 
    formatReadableSize(total_bytes) AS total_size
FROM system.tables
WHERE database = 'fpds_clickhouse' 
AND name = 'raw_contracts';

–ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
SELECT count() 
FROM system.columns 
WHERE table = 'raw_contracts' 
AND database = 'fpds_clickhouse';

–ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã (–∫–æ–ª–æ–Ω–∫–∏ –∏ –∏—Ö —Ç–∏–ø—ã)
DESCRIBE TABLE fpds_clickhouse.raw_contracts;

–ü–æ–ª–Ω–æ–µ DDL-–æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–≤–∫–ª—é—á–∞—è —Å–∂–∞—Ç–∏–µ –∏ –¥–≤–∏–∂–æ–∫)
SHOW CREATE TABLE fpds_clickhouse.raw_contracts;

–ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –≤ ClickHouse, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:
TRUNCATE TABLE fpds_clickhouse.raw_contracts;

–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É DELETE (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç DELETE):
DELETE FROM fpds_clickhouse.raw_contracts WHERE 1=1;

–ï—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä–≤—ã–µ 50 –∑–∞–ø–∏—Å–µ–π –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –∏—Å–ø–æ–ª—å–∑—É–π:
SELECT * FROM fpds_clickhouse.raw_contracts LIMIT 50;

–°–±—Ä–æ—Å–∏—Ç—å
UPDATE file_processing_status 
SET status = 'file_found', inserted_records = 0;


–£–î–ê–õ–ï–ù–ò–Ø –ó–ê –î–ï–ù–¨

–®–∞–≥ 1: –ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ 1980-02-15
SELECT COUNT(*)
FROM fpds_clickhouse.raw_contracts
WHERE 
    toDate(content__award__relevantContractDates__signedDate) = '1980-02-15'
    OR toDate(content__IDV__relevantContractDates__signedDate) = '1980-02-15'
    OR toDate(content__OtherTransactionAward__contractDetail__relevantContractDates__signedDate) = '1980-02-15'
    OR toDate(content__OtherTransactionIDV__contractDetail__relevantContractDates__signedDate) = '1980-02-15';

–ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ –¥–∞—Ç—É + –ø–∞—Ä—Ç–∏—Ü–∏—è
SELECT COUNT(*)
FROM fpds_clickhouse.raw_contracts
WHERE 
    partition_year = 1980
    AND (
        toDate(content__award__relevantContractDates__signedDate) = '1980-02-15'
        OR toDate(content__IDV__relevantContractDates__signedDate) = '1980-02-15'
        OR toDate(content__OtherTransactionAward__contractDetail__relevantContractDates__signedDate) = '1980-02-15'
        OR toDate(content__OtherTransactionIDV__contractDetail__relevantContractDates__signedDate) = '1980-02-15'
    );


–£–¥–∞–ª–∏—Ç—å 1000 –∑–∞–ø–∏—Å–µ–π
ALTER TABLE fpds_clickhouse.raw_contracts DELETE 
WHERE id IN (
    SELECT id
    FROM fpds_clickhouse.raw_contracts
    WHERE 
        toDate(content__award__relevantContractDates__signedDate) = '1980-02-15'
        OR toDate(content__IDV__relevantContractDates__signedDate) = '1980-02-15'
        OR toDate(content__OtherTransactionAward__contractDetail__relevantContractDates__signedDate) = '1980-02-15'
        OR toDate(content__OtherTransactionIDV__contractDetail__relevantContractDates__signedDate) = '1980-02-15'
    LIMIT 1000
);

–£–¥–∞–ª–∏—Ç—å 1000 –∑–∞–ø–∏—Å–µ–π + –ø–∞—Ä—Ç–∏—Ü–∏—è
ALTER TABLE fpds_clickhouse.raw_contracts DELETE 
WHERE partition_year = 1980
AND id IN (
    SELECT id FROM fpds_clickhouse.raw_contracts
    WHERE partition_year = 1980
    AND (
        toDate(content__award__relevantContractDates__signedDate) = '1980-02-15'
        OR toDate(content__IDV__relevantContractDates__signedDate) = '1980-02-15'
        OR toDate(content__OtherTransactionAward__contractDetail__relevantContractDates__signedDate) = '1980-02-15'
        OR toDate(content__OtherTransactionIDV__contractDetail__relevantContractDates__signedDate) = '1980-02-15'
    )
    LIMIT 1000
);

üî¥ –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ:
–í ClickHouse DELETE –Ω–µ —É–¥–∞–ª—è–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –∞ –ø–æ–º–µ—á–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è. –ß—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏, –≤—ã–ø–æ–ª–Ω–∏:

OPTIMIZE TABLE fpds_clickhouse.raw_contracts FINAL;

–ß—Ç–æ–±—ã –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–µ—Ä, –ª—É—á—à–µ –¥–µ–ª–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏—è–º:
OPTIMIZE TABLE fpds_clickhouse.raw_contracts PARTITION 1979 FINAL;

–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –º—É—Ç–∞—Ü–∏–∏
SELECT database, table, mutation_id, command, is_done, is_killed
FROM system.mutations
WHERE table = 'raw_contracts' AND database = 'fpds_clickhouse';


–ó–ê–ü–£–°–ö –í–°–¢–ê–í–ö–ò –í ClickHouse
cd fpds
source venv/bin/activate        
python insert_json_clickhouse.py


–ù–∞–π–¥–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –º—É—Ç–∞—Ü–∏–π:
find . -name 'mutation_*.txt'

–ù–∞–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –º—É—Ç–∞—Ü–∏–∏
find ./data/store -name 'mutation_*.txt' -delete

–ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ –ø–∞—Ä—Ç–∏—Ü–∏—é
SELECT COUNT(*) 
FROM fpds_clickhouse.raw_contracts 
WHERE partition_year = 1979;